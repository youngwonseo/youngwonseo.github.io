<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>딥러닝을 위한 고급도구#1 - 케라스 함수형 API</title>
  <meta name="description" content="다중출력과 다중입력 모델">

  <link rel="stylesheet" href="//css/main.css">
  <link rel="canonical" href="https://youngwonseo.github.io//2019/11/16/07-01-keras/">
  <link rel="alternate" type="application/atom+xml" title="Youngon.Seo" href="https://youngwonseo.github.io//feed.xml" />
</head>

  <body>
    

<div class="header-container" id="header-container">

<!-- Site navigation -->
  <nav class="site-nav">
    <div class="trigger">
      
        
        <a class="page-link" href="//about/">About</a>
        
      
        
        <a class="page-link" href="//archive/">Archive</a>
        
      
        
      
        
      
        
        <a class="page-link" href="//projects/">Projects</a>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
      <a class="page-link" href="//feed.xml">RSS</a>
      <a class="twitter page-link" href="https://twitter.com/fffabs"><span class="icon-twitter"></span></a>
      <a class="facebook page-link" href="https://www.facebook.com/fffabs"><span class="icon-facebook"></span></a>
    </div>
  </nav>

  <!-- The title of the site -->
  <header class="site-header">
    <a href="//">
      <div class="avatar">
        <img src="/assets/images/avatar.png" />
      </div>
    </a>
    <!-- <a class="site-title" href="//">Youngon.Seo</a> -->
  </header>

</div>

      <div class="wrapper">
        <div class="page-content">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">딥러닝을 위한 고급도구#1 - 케라스 함수형 API</h1>
    <p class="post-meta">November 16, 2019 • Youngwon Seo</p>
  </header>

  <!-- Beginning Twitter sharing Large button -->
  <!-- <a class="twitter-share-button" href="https://twitter.com/share"
  data-related="twitterdev"
  data-size="large"
  data-count="horizontal">
  Tweet
  </a> -->
  <!-- End of Twitter sharing button -->

  <!-- Facebook -->
  

  <article class="post-content">
    <h2 id="다중출력과-다중입력-모델">다중출력과 다중입력 모델</h2>

<p>지금까지 실습한 모델을 보면 모두 Sequential 모델을 사용하여 만들었습니다. Sequential 모델은 입력과 출력이 각각 하나라고 가정합니다. 하지만 경우에 따라 여러개의 입력이 사용되거나 여러개의 출력이 사용됩니다. 예를 들어 중고 의류 시장의 가격을 예측하는 모델을 생각해봅시다. 입력데이터로 의류의 메타데이터(의류 브랜드, 연도, 새상품가격 등), 설명글(의류 상태 등의 판매자가 작성한 글), 사진(의류 사진)을 입력으로 하면 메타데이터는 완전연결층, 설명글은 RNN, 사진은 CNN으로 처리할수가 있습니다.</p>

<p><img src="" alt="" /></p>

<p>간단하게는 각각을 전부 따로 사용하는 모델, 즉 각각의 입력이 가격을 예측하는 모델을 개발한 후 예측하는 가격의 평균을 사용하는 방법이지만 <strong>가능한 모든 종류의 입력 데이터를 동시에 사용해서 정확한 하나의 모델을 학습</strong>하는 것이 더 나은 방법입니다.</p>

<p>이와 비슷하게 입력은 하나이지만 출력이 여러개로 구분되는 모델도 존재할 수 있습니다.</p>

<p>최근 개발된 많은 신경망 구조는 이처럼 선형적이지 않은 네트워크 토폴로지(topology)가 필요합니다. 이에 대한 가장 대표적인 모델로 Inception 계열의 네트워크와 ResNet 계열의 네트워크 입니다. 다음의 그림을 살펴봅시다.</p>

<h4 id="inception">Inception</h4>
<p><img src="/public/keras/inception.png" alt="" /></p>

<h4 id="residual">Residual</h4>
<p><img src="/public/keras/residual.jpg" alt="" /></p>

<p>첫 번째 그림은 Inception 모듈을 의미합니다. 인셉션 모델은 인셉션 모듈들로 구성된 네트워크를 의미합니다. 인셉션 모듈을 살펴보면 입력이 여러개의 컨브넷으로 수행되고 다시 Concatenate됩니다. 
두 번째 그림은 Residual 모듈을 의미합니다. 하위층의 출력이 상위층의 출력이 더해지는 것을 볼 수 있습니다. 이 두가지 개념은 딥러닝 특히 CNN계열에서 아주 중요한 의미를 포함하고 있습니다. 뒤에서 코드와 함께 좀더 자세히 설명하겠습니다. 이 글에서의 핵심은 케라스의 함수형 API를 사용하면 위와 같은 다중출력 및 다중입력을 표현할 수 있다는 것입니다.</p>

<h2 id="케라스의-함수형-api">케라스의 함수형 API</h2>
<p>간단한 함수형 API예제를 살펴보겠습니다.</p>

<pre><code class="language-python">from keras import Input, layers

input_tensor = Input(shape=(32,))
dense = layers.Dense(32, activation='relu')

output_tensor = dense(input_tensor)
</code></pre>

<p>Input을 사용하여 입력을 만들고 dense에 Input을 입력하여 ouput을 만들어 내는 코드입니다. 다음은 Sequential과 함수형 API의 비교 코드입니다.</p>

<pre><code class="language-python">from keras.models import Sequential, Model
from keras import layers
from keras import Input

#Sequencetial 모델
seq_model = Sequential()
seq_model.add(layers.Dense(32, activation='relu', input_shape=(64,)))
seq_model.add(layers.Dense(32, activation='relu'))
seq_model.add(layers.Dense(10, activation='softmax'))


#함수형 API 모델
inpput_tensor = Input(shape=(64,))
x = layers.Dense(32, activation='relu')(input_tensor)
x = layers.Dense(32, activation='relu')(x)
output_tensor = layers.Dense(10, activation='softmax')(x)

model = Model(input_tensor, output_tensor)

model.summary()
</code></pre>
<p>add로 연결하던 층들을 함수의 입출력을 사용하여 연결하고 있습니다. 한 가지 중요한 사항은 함수형 API에서 모델을 생성하는 단계에서 Model에 입력과 출력을 입력하는데 이때 <strong>입력과 출력은 연결</strong>되어 있어야 합니다. 연결되어 있지 않다면 RuntimeError를 발생시킵니다.</p>

<h3 id="다중입력모델">다중입력모델</h3>
<p>다중 입력모델을 만들때는 여러개의 입력 텐서들을 연결해야하는데 이를 위해 케라스의 keras.layers.add, keras.layers.concatenate 등을 사용합니다.</p>

<p><img src="/public/keras/multiple_input.png" alt="" /></p>

<p>예를 들어 질문-응답모델을 만든다고 생각해 봅시다. 입력은 질문과 답변이 존재하는 지문 출력은 응답이 있습니다. 입력이 두개이므로 다중입력 모델입니다. concatenate를 사용한 모델 코드를 살펴보겠습니다(Emdedding, LSTM등은 6장에서 살펴보았습니다).</p>

<pre><code class="language-python">from keras.models import Model
from keras import layers
from keras import Input

text_vocabulary_size = 10000
question_vocabulary_size = 10000
answer_vocabulary_size = 500

#첫 번째 입력
text_input = Input(shape=(None,), dtype='int32', name='text')
embedded_text = layers.Embedding(text_vocabulary_size, 64)(text_input)
encoded_text = layers.LSTM(32)(embedded_text)

#두 번째 입력
question_input = Input(shape=(None,), dtype='int32', name='question')
embedded_question = layers.Embedding(question_vocabulary_size, 32)(question_input)
encoded_question = layers.LSTM(16)(embedded_question)

concatenated = layers.concatenate([encoded_text, encoded_question], axis=-1) # 두개의 텐서를 연결

answer = layers.Dense(answer_vocabulary_size, activation='softmax')(concatenated)

model = Model([text_input, question_input], answer) #2개의 입력과 출력
model.compile(optimizer='rmsprop', loss='categorical_crossentropy', metrics=['acc'])
</code></pre>

<p>다음은 모델의 학습입니다. 입력과 출력데이터를 임의로 생성합니다.</p>
<pre><code class="language-python">import numpy as np
from keras.utils import to_categorical

num_samples = 1000
max_length = 100

text = np.random.randint(1, text_vocabulary_size, size=(num_samples, max_length))
question = np.random.randint(1, question_vocabulary_size, size=(num_samples, max_length))


answers = np.random.randint(0, answer_vocabulary_size, size=num_samples)
answers = to_categorical(answers)

model.fit([text, question], answers, epochs=10, batch_size=128)
#model.fit({'text':text, 'question':question}, answers, epochs=10, batch_size=128)
#입력 텐서에 지정된 이름(name)을 통해 데이터 주입가능
</code></pre>
<p>fit을 통해 학습시킬때 데이터를 주입하는 방식이 두가지 존재합니다. 첫번째는 순서에 맞게 리스트로 구성하여 입력하는것과 모델구성시 입력에 지정된 이름을 통해 dict로 주입하는 방법입니다.</p>

<h3 id="다중출력모델">다중출력모델</h3>
<p>다중입력모델은 입력을 concatenate로 합치는 것이 특징입니다. 이와 다르게 다중출력모델은 출력이 여러개이므로 <strong>각 출력에 대한 loss가 지정</strong>되는것이 특징입니다. 입력이 상위계층으로 연결되면서 여러개의 층에 나눠서 들어가고 출력이 각각 결정되는것입니다. 다음은 소셜 미디어의 글을 가지고 작성자의 나이, 성별, 소득 수준을 예측하는 모델의 예제입니다.</p>

<p><img src="/public/keras/multiple_output.png" alt="" /></p>

<pre><code class="language-python">from keras import layers
from keras import Input
from keras.models import Model
vocabulary_size = 50000
num_income_groups = 10

posts_input = Input(shape=(None,), dtype='int32', name='posts')
embedded_posts = layers.Embedding(vocabulary_size, 256)(posts_input)
x = layers.Conv1D(128, 5, activation='relu')(embedded_posts)
x = layers.MaxPooling1D(256, 5)(x)
x = layers.Conv1D(128, 5, activation='relu')(x)
x = layers.Conv1D(128, 5, activation='relu')(x)
x = layers.MaxPooling1D(256, 5)(x)
x = layers.Conv1D(128, 5, activation='relu')(x)
x = layers.Conv1D(128, 5, activation='relu')(x)
x = layers.GlobalMaxPooling1D()(x)
x = layers.Dense(128, activation='relu')(x)

#여기서 3개의 층으로 나누어짐
#출력1 - 나이
age_prediction = layers.Dense(1, name='age')(x) 
#출력2 - 소득
income_prediction = layers.Dense(num_income_groups, activation='softmax', name='income')(x)
#출력1 - 성별
gender_prediction = layers.Dense(1, activation='sigmoid', name='gender')(x)


model = Model(posts_input, [age_prediction, income_prediction, gender_prediction])

#리스트 표현법
model.compile(optimizer='rmsprop', loss=['mse', 'categorical_crossentropy', 'binary_crossentropy'])
#딕셔너리 표현법
model.compile(optimizer='remsprop', loss={'age':'mse', 'income':'categorical_crossentropy', 'gender':'binary_crossentropy'})
</code></pre>

<p>각 출력은 다음과 같은 특징을 가집니다(소득의 경우 회귀(스칼라 예측)가 될 수 있지만 본 예제에서는 10개의 등급으로 나누었기 때문에 다중분류로 처리합니다).</p>
<ul>
  <li>나이 : 회귀</li>
  <li>소득 : 다중분류</li>
  <li>성별 : 이중분류</li>
</ul>

<p>그렇다면 손실을 가지고 학습을 진행하는 딥러닝은 여러개의 손실을 어떻게 사용해서 모델을 학습할까요? 가장 간단한 방법은 여러개의 손실을 모두 더하는 것입니다. 하지만 그렇게 학습할 경우 상대적으로 손실이 큰 항목을 위주로 학습일 될 것입니다. 이를 방지하기 위해 각 손실에 대한 기여도를 loss_weight으로 지정할 수 있습니다.</p>
<pre><code class="language-python">#리스트 표현법
model.compile(optimizer='rmsprop', 
              loss=['mse', 'categorical_crossentropy', 'binary_crossentropy'],
              loss_weight=[0.25, 1., 10.])
#딕셔너리 표현법
model.compile(optimizer='remsprop', 
              loss={'age':'mse', 'income':'categorical_crossentropy', 'gender':'binary_crossentropy'},
              loss_weight={'age':0.25, 'income':1., 'gender':10.}
            )

</code></pre>
<p>나이의 경우 3~5의 오차(mse), 성별은 0.1정도의 오차(crossentorpy)가 존재한다고 할때 위와 같이 손실에 스케일링값을 주어 다중 출력 모델에서 전체의 loss를 조절할 수 있습니다.</p>

<p>다음은 위 모델의 학습에 대한 코드입니다.</p>
<pre><code class="language-python">#리스트 표현법
model.fit(posts, [age_targets, income_targets, gender_targets],
          epochs=10, batch_size=64)
#딕셔너리 표현법
model.fit(posts, {'age': age_targets, 'income': income_targets, 'gender': gender_targets],
          epochs=10, batch_size=64)
</code></pre>

<h3 id="inception과-residual">Inception과 Residual</h3>
<p>위에서 잠시 언급했던 Inception과 Residual을 좀더 자세히 살펴봅시다.</p>

<p>함수형 API를 사용하면 다중 입/출력 모델 뿐만 아니라 비순환 유향 그래프(directed acyclic graph, DAG)를 만들 수 있습니다. 비순환이라는 것이 중요합니다. 이러한 구조중 가장 유명한 것이 Inception과 Residual입니다.</p>

<h4 id="inception-1">Inception</h4>
<p><img src="/public/keras/inception.png" alt="" />
Inception은 network in network 구조에 영감을 받아 구글에서 만든 CNN기반 모듈로 여러개의 CNN 구조를 거쳐 Concatenate를 통해 하나로 출력하는 모듈을 의미합니다. 1x1 합성곱과 3x3 합성곱등이 포함됩니다. 이런 구성(모듈안의 구성)은 네트워크가 따로따로 공간 특성과 채널 방향의 특성을 학습하도록 돕습니다. 종류에 따라 V1, V2, V3등의 모델로 구분(모듈을 구성하는 컨브넷의 사이즈, 개수 등이 차이)됩니다.</p>

<p>여기서 Inception의 직접적인 구현코드는 살펴보지 않겠습니다(책을 참조해주세요). 케라스API(keras.applications.inception_v3.InceptionV3)에는 Inception을 구현해놓고 ImageNet데이터로 학습한 모델을 지원합니다.</p>

<blockquote>
  <p>참조 논문 : Going Deeper with Convolutions(https://arxiv.org/abs/1409.4842)</p>
</blockquote>

<h4 id="resnet">ResNet</h4>
<p><img src="/public/keras/residual.jpg" alt="" />
Residual connection을 살펴보면 하위층의 출력을 상위층에 더하는 역활을 합니다. 이는 대규모 딥러닝 모델(층이 많은)에서 흔히 나타나는 두가지 문제인 그래디언트 소실(vanishing gradient)과 표현 병목(representational bottleneck)을 해결한 모델입니다. 일반적으로 10개 이상의 층을 가진 모델에 Residual connection을 추가하면 도움이 됩니다.</p>

<p>기본원리는 하위층의 출력이 상위층의 출력에 더해지는것입니다. 그래서 두층의 아웃풋의 텐서 크기가 동일해야 합니다. layers.add([y, redidual])과 같이 더하여 적용합니다.</p>

<blockquote>
  <p>참조 논문 : Deep Residual Learning for Image Recognition(https://arxiv.org/abs/1512.03385)</p>
</blockquote>

<h3 id="층-가중치-공유">층 가중치 공유</h3>
<p>함수형 API의 또 다른 특징은 하나의 층을 두번 호출하여 새로운 층을 생성하지 않고 같은 층의 가중치를 공유해서 사용하는 것입니다.</p>

<p>예를 들어 두 문장의 의미가 비슷한지 측정하는 모델을 가정해 봅시다. 이 모델은 두개의 문장을 입력으로 받고 0또는 1을 출력합니다(대화 시스템에서 중복 질문 제거 등에 유용하게 사용될 수 있습니다).</p>

<pre><code class="language-python">from keras import layers
from keras import Input
from keras.models import Model

lstm = layers.LSTM(32) #하나의 lstm
left_input = Input(shape=(None, 128))
left_output = lstm(left_input)

right_input = Input(shape=(None, 128))
right_output = lstm(right_input)

merged = layers.concatenate([left_output, right_output], axis=-1)
predictions = layers.Dense(1, activation='sigmoid')(merged)

model = Model([left_input, right_input], predictions)
model.fit([left_data, right_data], targets)

</code></pre>
<p>이 모델의 경우 A와 B나 B와 A의 입력의 출력이 같아야 합니다. 그래서 입력 A와 입력 B가 같은 lstm을 사용하고 있습니다. 두개의 입력에 대해 함께 학습되는 lstm으로 이를 샴 LSTM(siamese LSTM)모델 또는 공유 LSTM 이라고 부릅니다. 이처럼 함수형 API를 사용하면 모델에 따라 공유하는 층을 사용할 수 있습니다.</p>

<h3 id="모델과-층">모델과 층</h3>
<p>마지막으로 함수형 API를 사용하면 <strong>모델</strong>을 <strong>층</strong>처럼 사용할 수 있습니다.</p>

  </article>

  <hr>

  
    <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://youngwonseo.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  
  <!-- <div class="question">
    <h2>Questions?</h2>
    <p>Have a question regarding the post above? <br />Or any of my designs?</p>
    <a class="twitter-follow-button"
    href="https://twitter.com/fffabs"
    data-show-count="true"
    data-size="large">
    Follow @fffabs
    </a>
    <script type="text/javascript">
    window.twttr = (function (d, s, id) {
      var t, js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src= "https://platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js, fjs);
      return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
    }(document, "script", "twitter-wjs"));
    </script>
  </div> -->

  <div class="related">
    <h2>Related</h2>
    
      <li><a href="/2020/10/09/image-resize/" title="파이썬 이미지 리사이즈">파이썬 이미지 리사이즈
       &nbsp; <span class="post-meta">October 09, 2020</span></a>
    
      <li><a href="/2020/09/22/class-activation-map/" title="Learning Deep Features for Discriminative Localization">Learning Deep Features for Discriminative Localization
       &nbsp; <span class="post-meta">September 22, 2020</span></a>
    
      <li><a href="/2020/09/21/network-in-network/" title="Network In Network">Network In Network
       &nbsp; <span class="post-meta">September 21, 2020</span></a>
    
  </div>

</div>

        </div>
        <footer class="site-footer">
<p class="small">YoungwonSeo &copy 2020
</p>
</footer>

    </div>

    <script src="//cdn.jsdelivr.net/headroomjs/0.5.0/headroom.min.js"></script>
    <script type="text/javascript">
      var el = document.querySelector(".header-container");
      var headroom  = new Headroom(el, {
        "offset": 205,
        "tolerance": 5
      });
      headroom.init();
    </script>


    <!-- Twitter Shizzle -->
    <!-- <script type="text/javascript">
    window.twttr = (function (d, s, id) {
      var t, js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src= "https://platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js, fjs);
      return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
    }(document, "script", "twitter-wjs"));
    </script> -->
    	<!-- Google Analytics -->
  <script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		
		ga('create', 'UA-78263144-1', 'auto');
		ga('send', 'pageview');
		</script>
		<!-- End Google Analytics -->
</header>


  </body>
</html>
